<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tetris Versus - Lobby</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: #20202b;
            color: #fff;
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }

        .lobby-container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        .lobby-header {
            padding: 1rem;
            background: #16161e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lobby-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .players-panel {
            width: 300px;
            background: #2a2a3a;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a24;
        }

        .player-item {
            background: #3a3a4a;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-item.you {
            border: 2px solid #0f0;
        }

        .player-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #0f0;
            margin-right: 10px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            background: #2a2a3a;
            border-radius: 5px;
        }

        .chat-message-sender {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .chat-message-text {
            color: #ddd;
        }

        .chat-input-area {
            padding: 20px;
            background: #16161e;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #3a3a4a;
            border-radius: 5px;
            background: #2a2a3a;
            color: white;
            font-size: 16px;
        }

        .btn-send {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-send:hover {
            background: #5568d3;
        }

        .btn-back {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-back:hover {
            background: #c0392b;
        }

        .btn-start-game {
            padding: 15px 30px;
            background: #2cb45a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin-top: 20px;
            width: 100%;
        }

        .btn-start-game:hover {
            background: #259449;
        }

        .btn-start-game:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .waiting-message {
            text-align: center;
            padding: 20px;
            color: #aaa;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="lobby-container">
        <div class="lobby-header">
            <h2>Multiplayer Lobby</h2>
            <button class="btn-back" onclick="goBack()">‚Üê Back to Home</button>
        </div>

        <div class="lobby-content">
            <div class="players-panel">
                <h3>Connected Players</h3>
                <div id="players-list"></div>
                <button id="start-game-btn" class="btn-start-game" disabled onclick="startGame()">
                    Start Game (Need 2 Players)
                </button>
            </div>

            <div class="chat-panel">
                <div class="chat-messages" id="chat-messages">
                    <div class="waiting-message">Waiting for messages...</div>
                </div>
                <div class="chat-input-area">
                    <input 
                        type="text" 
                        id="chat-input" 
                        class="chat-input" 
                        placeholder="Type a message..."
                        onkeypress="handleChatKeyPress(event)"
                    >
                    <button class="btn-send" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || !user.username) {
            window.location.href = 'login.html';
        }

        let ws = null;
        let connectedPlayers = new Map();
        let myClientId = null;

        function connectToLobby() {
            //Connect to WebSocket on same port as HTTP server
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            console.log('Connecting to WebSocket:', wsUrl);
            ws = new WebSocket(wsUrl);

            ws.addEventListener('open', () => {
                console.log('Connected to lobby');
                ws.send(JSON.stringify({
                    type: 'join-lobby',
                    username: user.username,
                    userId: user.id
                }));
            });

            ws.addEventListener('message', (event) => {
                const data = JSON.parse(event.data);
                console.log('Lobby message:', data);

                switch (data.type) {
                    case 'lobby-state':
                        myClientId = data.yourId;
                        updatePlayersList(data.players);
                        break;
                    case 'chat-message':
                        displayChatMessage(data.username, data.message);
                        break;
                    case 'game-start':
                        console.log('Game starting, joining session:', data.sessionId);
                        //Close websocket before redirect to prevent reconnection
                        ws.close();
                        window.location.href = `index.html#${data.sessionId}`;
                        break;
                }
            });

            ws.addEventListener('close', () => {
                console.log('Disconnected from lobby');
                setTimeout(connectToLobby, 2000); //Reconnect
            });

            ws.addEventListener('error', (error) => {
                console.error('WebSocket error:', error);
            });
        }

        function updatePlayersList(players) {
            connectedPlayers = new Map(players.map(p => [p.id, p]));
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';

            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item' + (player.id === myClientId ? ' you' : '');
                playerDiv.innerHTML = `
                    <div>
                        <span class="player-status"></span>
                        ${player.username} ${player.id === myClientId ? '(You)' : ''}
                    </div>
                `;
                playersList.appendChild(playerDiv);
            });

            //Enable start button if 2 or more players
            const startBtn = document.getElementById('start-game-btn');
            if (players.length >= 2) {
                startBtn.disabled = false;
                startBtn.textContent = 'Start Game';
            } else {
                startBtn.disabled = true;
                startBtn.textContent = `Start Game (${players.length}/2 Players)`;
            }
        }

        function displayChatMessage(username, message) {
            const messagesDiv = document.getElementById('chat-messages');
            
            //Remove waiting message
            const waitingMsg = messagesDiv.querySelector('.waiting-message');
            if (waitingMsg) {
                waitingMsg.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.innerHTML = `
                <div class="chat-message-sender">${username}</div>
                <div class="chat-message-text">${message}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (message && ws && ws.readyState === WebSocket.OPEN) {
                displayChatMessage(user.username, message);
                
                //Then send to server (server won't echo back)
                ws.send(JSON.stringify({
                    type: 'chat-message',
                    message: message
                }));
                input.value = '';
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function startGame() {
            if (ws && ws.readyState === WebSocket.OPEN && connectedPlayers.size >= 2) {
                ws.send(JSON.stringify({
                    type: 'start-game'
                }));
            }
        }

        function goBack() {
            if (ws) {
                ws.close();
            }
            window.location.href = 'home.html';
        }

        //Connect on page load
        connectToLobby();
    </script>
</body>
</html>